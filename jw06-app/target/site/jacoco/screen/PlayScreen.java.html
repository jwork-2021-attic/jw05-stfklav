<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlayScreen.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">191220091-Roguelike</a> &gt; <a href="index.source.html" class="el_package">screen</a> &gt; <span class="el_source">PlayScreen.java</span></div><h1>PlayScreen.java</h1><pre class="source lang-java linenums">package screen;

import world.*;
import asciiPanel.AsciiPanel;
import java.awt.Color;
import java.awt.event.KeyEvent;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.*;

import javax.swing.JOptionPane;

import java.util.Timer;
import java.util.TimerTask;

public class PlayScreen implements Screen, Serializable {

    private World world;
    private transient Creature player; // 玩家
    private ArrayList&lt;String&gt; messages;
    private ArrayList&lt;String&gt; oldMessages;

    public boolean gameStatus; // 游戏是不是被暂停

    public int MONSTER_NUMBER;
    public int FUNGUS_NUMBER;
    public int MEDICINE_NUMBER;
    public int AMPLIFIER_NUMBER;
    public int level;

<span class="nc" id="L37">    public PlayScreen(int monster_num, int fungus_num, int medicine_num, int amplifier_num, int level) {</span>
<span class="nc" id="L38">        MONSTER_NUMBER = monster_num;</span>
<span class="nc" id="L39">        FUNGUS_NUMBER = fungus_num;</span>
<span class="nc" id="L40">        MEDICINE_NUMBER = medicine_num;</span>
<span class="nc" id="L41">        AMPLIFIER_NUMBER = amplifier_num;</span>
<span class="nc" id="L42">        this.level = level;</span>

<span class="nc" id="L44">        gameStatus = true;</span>

<span class="nc" id="L46">        createWorld();</span>
<span class="nc" id="L47">        this.messages = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L48">        this.oldMessages = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L50">        CreatureFactory creatureFactory = new CreatureFactory(this.world);</span>
<span class="nc" id="L51">        createCreatures(creatureFactory);</span>
<span class="nc" id="L52">    }</span>

    private void createCreatures(CreatureFactory creatureFactory) {
        // this.player = creatureFactory.newPlayer(this.messages);

        // 开创线程池创造怪物
<span class="nc" id="L58">        ExecutorService exec = Executors.newFixedThreadPool(MONSTER_NUMBER + 1);</span>
<span class="nc" id="L59">        this.player = creatureFactory.newPlayer(this.messages);</span>
<span class="nc" id="L60">        player.setStatus(gameStatus);</span>
<span class="nc" id="L61">        exec.execute(player);</span>
<span class="nc" id="L62">        new Timer().schedule(new TimerTask() {</span>
            @Override
            public void run() {
                // 限制屏幕上剩余怪物数量
<span class="nc" id="L66">                List&lt;Creature&gt; monsters = world.monsterRemain();</span>
<span class="nc bnc" id="L67" title="All 4 branches missed.">                if (monsters.size() &lt; MONSTER_NUMBER &amp;&amp; gameStatus) {</span>
<span class="nc" id="L68">                    Creature m = creatureFactory.newMonster(player);</span>
<span class="nc" id="L69">                    m.setStatus(gameStatus);</span>
<span class="nc" id="L70">                    monsters.add(m); // 添加新的怪物</span>
<span class="nc" id="L71">                    exec.execute(m);</span>
                }
<span class="nc" id="L73">            }</span>

<span class="nc" id="L75">        }, 5000, 5000); // 一开始等五秒，之后每五秒检查一次</span>
        // exec.shutdown();

<span class="nc bnc" id="L78" title="All 2 branches missed.">        for (int i = 0; i &lt; FUNGUS_NUMBER; i++) {</span>
<span class="nc" id="L79">            creatureFactory.newFungus();</span>
        }

<span class="nc bnc" id="L82" title="All 2 branches missed.">        for (int i = 0; i &lt; MEDICINE_NUMBER; i++) {</span>
<span class="nc" id="L83">            creatureFactory.newMedicine();</span>
        }

<span class="nc bnc" id="L86" title="All 2 branches missed.">        for (int i = 0; i &lt; AMPLIFIER_NUMBER; i++) {</span>
<span class="nc" id="L87">            creatureFactory.newAmplifier();</span>
        }
<span class="nc" id="L89">    }</span>

    private void createWorld() {
<span class="nc" id="L92">        world = new WorldBuilder(World.WIDTH, World.HEIGHT).makeCaves().build();</span>
<span class="nc" id="L93">    }</span>

    private void displayTiles(AsciiPanel terminal) {
        // Show terrain
<span class="nc bnc" id="L97" title="All 2 branches missed.">        for (int x = 0; x &lt; World.WIDTH; x++) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            for (int y = 0; y &lt; World.HEIGHT; y++) {</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                if (player.canSee(x, y)) {</span>
<span class="nc" id="L100">                    terminal.write(world.glyph(x, y), x, y, world.color(x, y));</span>
<span class="nc" id="L101">                } else {</span>
<span class="nc" id="L102">                    terminal.write(world.glyph(x, y), x, y, Color.DARK_GRAY);</span>
                }
            }
        }
        // Show creatures
<span class="nc bnc" id="L107" title="All 2 branches missed.">        for (Creature creature : world.getCreatures()) {</span>
<span class="nc bnc" id="L108" title="All 4 branches missed.">            if (creature.type() == CreatureType.FUNGUS || creature.type() == CreatureType.MEDICINE ||</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">                    creature.type() == CreatureType.AMPLIFIER) {</span>
                // 照亮才能看见
<span class="nc bnc" id="L111" title="All 6 branches missed.">                if (creature.x() &gt;= 0 &amp;&amp; creature.x() &lt; World.WIDTH &amp;&amp; creature.y() &gt;= 0</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                        &amp;&amp; creature.y() &lt; World.HEIGHT) {</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">                    if (player.canSee(creature.x(), creature.y())) {</span>
<span class="nc" id="L114">                        terminal.write(creature.glyph(), creature.x(), creature.y(), creature.color());</span>
                    }
                }
<span class="nc" id="L117">            } else {</span>
                // 不用照亮就能看见
<span class="nc bnc" id="L119" title="All 6 branches missed.">                if (creature.x() &gt;= 0 &amp;&amp; creature.x() &lt; World.WIDTH &amp;&amp; creature.y() &gt;= 0</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">                        &amp;&amp; creature.y() &lt; World.HEIGHT) {</span>
<span class="nc" id="L121">                    terminal.write(creature.glyph(), creature.x(), creature.y(), creature.color());</span>
                }
            }
        }
        // Creatures can choose their next action now
        // world.update();
<span class="nc" id="L127">    }</span>

    private void displayMessages(AsciiPanel terminal, List&lt;String&gt; messages) {
<span class="nc" id="L130">        int top = World.HEIGHT + 5;</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        for (int i = 0; i &lt; messages.size(); i++) {</span>
<span class="nc" id="L132">            terminal.write(messages.get(i), 1, top + i);</span>
        }
<span class="nc" id="L134">        oldMessages.addAll(messages);</span>
<span class="nc" id="L135">        messages.clear();</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (oldMessages.size() &gt; 0) {</span>
<span class="nc" id="L137">            messages.add(oldMessages.get(oldMessages.size() - 1));</span>
        }
<span class="nc" id="L139">    }</span>

    // setters and getters 序列化输出输入
    private void writeObject(ObjectOutputStream oos) throws IOException {
<span class="nc" id="L143">        oos.defaultWriteObject();</span>
<span class="nc" id="L144">    }</span>

    private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException {
<span class="nc" id="L147">        ois.defaultReadObject();</span>

        // 给大家换上正确的AI
<span class="nc" id="L150">        player = world.playerRemain().get(0);</span>
<span class="nc" id="L151">        new PlayerAI(player, messages);</span>

<span class="nc" id="L153">        List&lt;Creature&gt; monsters = world.monsterRemain();</span>
<span class="nc" id="L154">        List&lt;Creature&gt; fungus = world.fungusRemain();</span>
<span class="nc" id="L155">        List&lt;Creature&gt; medicines = world.medicineRemain();</span>
<span class="nc" id="L156">        List&lt;Creature&gt; amplifiers = world.amplifierRemain();</span>

<span class="nc bnc" id="L158" title="All 2 branches missed.">        for (Creature m : monsters) {</span>
<span class="nc" id="L159">            new MonsterAI(m, this.world, player);</span>
        }
<span class="nc bnc" id="L161" title="All 2 branches missed.">        for (Creature f : fungus) {</span>
<span class="nc" id="L162">            new FungusAI(f);</span>
        }
<span class="nc bnc" id="L164" title="All 2 branches missed.">        for (Creature m : medicines) {</span>
<span class="nc" id="L165">            new MedicineAI(m);</span>
        }
<span class="nc bnc" id="L167" title="All 2 branches missed.">        for (Creature a : amplifiers) {</span>
<span class="nc" id="L168">            new AmplifierAI(a);</span>
        }

<span class="nc" id="L171">    }</span>

    // 序列化
    public void serializing() throws IOException, ClassNotFoundException {
<span class="nc" id="L175">        FileOutputStream fileOutputStream = new FileOutputStream(Screen.FileName);</span>
<span class="nc" id="L176">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream);</span>
<span class="nc" id="L177">        objectOutputStream.writeObject(this);</span>
<span class="nc" id="L178">        objectOutputStream.flush();</span>
<span class="nc" id="L179">        objectOutputStream.close();</span>
<span class="nc" id="L180">    }</span>

    public void run() {
<span class="nc" id="L183">        gameStatus = false;</span>
        // 跑起来
<span class="nc" id="L185">        ExecutorService exec = Executors.newFixedThreadPool(MONSTER_NUMBER + 1);</span>
<span class="nc" id="L186">        player.setStatus(gameStatus);</span>
<span class="nc" id="L187">        exec.execute(player);</span>

<span class="nc" id="L189">        List&lt;Creature&gt; monsters = world.monsterRemain();</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        for (Creature m : monsters) { // 添加现有的怪物</span>
<span class="nc" id="L191">            m.setStatus(gameStatus);</span>
<span class="nc" id="L192">            exec.execute(m);</span>
        }
        // 怪物添加
<span class="nc" id="L195">        CreatureFactory creatureFactory = new CreatureFactory(world);</span>
<span class="nc" id="L196">        new Timer().schedule(new TimerTask() {</span>
            @Override
            public void run() {
                // 限制屏幕上剩余怪物数量
<span class="nc" id="L200">                List&lt;Creature&gt; monsters = world.monsterRemain();</span>
<span class="nc bnc" id="L201" title="All 4 branches missed.">                if (monsters.size() &lt; MONSTER_NUMBER &amp;&amp; gameStatus) {</span>
<span class="nc" id="L202">                    Creature m = creatureFactory.newMonster(player);</span>
<span class="nc" id="L203">                    m.setStatus(gameStatus);</span>
<span class="nc" id="L204">                    monsters.add(m); // 添加新的怪物</span>
<span class="nc" id="L205">                    exec.execute(m);</span>
                }
<span class="nc" id="L207">            }</span>

<span class="nc" id="L209">        }, 5000, 5000); // 一开始等五秒，之后每五秒检查一次</span>

<span class="nc" id="L211">    }</span>

    @Override
    public Screen displayOutput(AsciiPanel terminal) {
        // Terrain and creatures
<span class="nc" id="L216">        displayTiles(terminal);</span>
        // Player
<span class="nc" id="L218">        terminal.write(player.glyph(), player.x(), player.y(), player.color());</span>
        // Stats
<span class="nc" id="L220">        String levelstats = String.format(&quot;Level:%3d&quot;, this.level);</span>
<span class="nc" id="L221">        terminal.write(levelstats, 1, World.HEIGHT);</span>

<span class="nc" id="L223">        String hpstats = String.format(&quot;%3d/%3d hp&quot;, player.hp(), player.maxHP());</span>
<span class="nc" id="L224">        terminal.write(hpstats, 1, World.HEIGHT + 2);</span>

<span class="nc" id="L226">        String stats = String.format(&quot;Get%3d/%3d Hearts&quot;, FUNGUS_NUMBER - world.fungusRemain().size(), FUNGUS_NUMBER);</span>
<span class="nc" id="L227">        terminal.write(stats, 1, World.HEIGHT + 3);</span>

        // Messages
<span class="nc" id="L230">        displayMessages(terminal, this.messages);</span>

        // 判断player是不是已经死了
<span class="nc bnc" id="L233" title="All 2 branches missed.">        if (player.hp() &lt;= 0) {</span>
<span class="nc" id="L234">            return new LoseScreen();</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">        } else if (world.fungusRemain().size() == 0) {</span>
            // 是否赢得胜利
<span class="nc" id="L237">            return new WinScreen();</span>
        }
<span class="nc" id="L239">        return this;</span>
    }

    @Override
    public Screen respondToUserInput(KeyEvent key) {
<span class="nc bnc" id="L244" title="All 4 branches missed.">        if (key.isControlDown() &amp;&amp; key.getKeyCode() == KeyEvent.VK_S) {// 同时按下ctrl+S</span>
            // 首先暂停游戏 改变游戏状态
<span class="nc bnc" id="L246" title="All 2 branches missed.">            if (gameStatus) {</span>
<span class="nc" id="L247">                gameStatus = false;</span>
            }
            // 通知怪物
<span class="nc" id="L250">            List&lt;Creature&gt; monsters = world.monsterRemain();</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">            for (Creature m : monsters) {</span>
<span class="nc" id="L252">                m.setStatus(gameStatus);</span>
            }
            // 通知玩家
<span class="nc" id="L255">            player.setStatus(gameStatus);</span>

<span class="nc" id="L257">            int res = JOptionPane.showConfirmDialog(null, &quot;已暂停，是否保存当前游戏进度并退出&quot;, &quot;Option&quot;, JOptionPane.YES_NO_OPTION);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">            if (res == JOptionPane.YES_OPTION) {</span>
                // 点击“是”后执行这个代码块
                // 保存并退出游戏
                try {
<span class="nc" id="L262">                    serializing();</span>
<span class="nc" id="L263">                } catch (Exception e) {</span>
                    // e.printStackTrace();
<span class="nc" id="L265">                    System.out.println(&quot;序列化失败！&quot;);</span>
                }

<span class="nc" id="L268">                JOptionPane.showMessageDialog(null, &quot;保存成功&quot;, &quot;Information&quot;, JOptionPane.INFORMATION_MESSAGE);</span>
<span class="nc" id="L269">                System.exit(0); // 摁退出</span>
<span class="nc" id="L270">            } else {</span>
                // 点击“否”后执行这个代码块
                // 继续游戏
<span class="nc" id="L273">                gameStatus = true;</span>
                // 通知怪物
<span class="nc" id="L275">                monsters = world.monsterRemain();</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">                for (Creature m : monsters) {</span>
<span class="nc" id="L277">                    m.setStatus(gameStatus);</span>
                }
                // 通知玩家
<span class="nc" id="L280">                player.setStatus(gameStatus);</span>
            }

<span class="nc" id="L283">        } else {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">            switch (key.getKeyCode()) {</span>
                case KeyEvent.VK_SPACE: {
                    // 改变游戏状态
<span class="nc bnc" id="L287" title="All 2 branches missed.">                    if (gameStatus) {</span>
<span class="nc" id="L288">                        gameStatus = false;</span>
<span class="nc" id="L289">                    } else {</span>
<span class="nc" id="L290">                        gameStatus = true;</span>
                    }

                    // 通知怪物
<span class="nc" id="L294">                    List&lt;Creature&gt; monsters = world.monsterRemain();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">                    for (Creature m : monsters) {</span>
<span class="nc" id="L296">                        m.setStatus(gameStatus);</span>
                    }

                    // 通知玩家
<span class="nc" id="L300">                    player.setStatus(gameStatus);</span>
                }
<span class="nc" id="L302">                    break;</span>
                default:
<span class="nc" id="L304">                    player.setKeyEvent(key.getKeyCode());</span>
                    break;
            }
        }
<span class="nc" id="L308">        return this;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>
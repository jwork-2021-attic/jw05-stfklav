<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlayScreen.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">roguelike</a> &gt; <a href="index.source.html" class="el_package">com.nju.roguelike.screen</a> &gt; <span class="el_source">PlayScreen.java</span></div><h1>PlayScreen.java</h1><pre class="source lang-java linenums">package com.nju.roguelike.screen;

import com.nju.roguelike.world.*;
import asciiPanel.AsciiPanel;
import java.awt.Color;
import java.awt.event.KeyEvent;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.*;

import javax.swing.JOptionPane;

import java.util.Timer;
import java.util.TimerTask;

public class PlayScreen implements Screen, Serializable {

    private World world;
    private transient Creature player; // 玩家
    private ArrayList&lt;String&gt; messages;
    private ArrayList&lt;String&gt; oldMessages;

    public boolean gameStatus; // 游戏是不是被暂停

    public int MONSTER_NUMBER;
    public int FUNGUS_NUMBER;
    public int MEDICINE_NUMBER;
    public int AMPLIFIER_NUMBER;
    public int level;

<span class="nc" id="L37">    public PlayScreen(int monster_num, int fungus_num, int medicine_num, int amplifier_num, int level) {</span>
<span class="nc" id="L38">        MONSTER_NUMBER = monster_num;</span>
<span class="nc" id="L39">        FUNGUS_NUMBER = fungus_num;</span>
<span class="nc" id="L40">        MEDICINE_NUMBER = medicine_num;</span>
<span class="nc" id="L41">        AMPLIFIER_NUMBER = amplifier_num;</span>
<span class="nc" id="L42">        this.level = level;</span>

<span class="nc" id="L44">        gameStatus = true;</span>

<span class="nc" id="L46">        createWorld();</span>
<span class="nc" id="L47">        this.messages = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L48">        this.oldMessages = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L50">        CreatureFactory creatureFactory = new CreatureFactory(this.world);</span>
<span class="nc" id="L51">        createCreatures(creatureFactory);</span>
<span class="nc" id="L52">    }</span>

    private void createCreatures(CreatureFactory creatureFactory) {

        // 开创线程池创造怪物
<span class="nc" id="L57">        ExecutorService exec = Executors.newFixedThreadPool(MONSTER_NUMBER + 1);</span>
<span class="nc" id="L58">        this.player = creatureFactory.newPlayer(this.messages);</span>
<span class="nc" id="L59">        player.setStatus(gameStatus);</span>
<span class="nc" id="L60">        exec.execute(player);</span>
<span class="nc" id="L61">        new Timer().schedule(new TimerTask() {</span>
            @Override
            public void run() {
                // 限制屏幕上剩余怪物数量
<span class="nc" id="L65">                List&lt;Creature&gt; monsters = world.monsterRemain();</span>
<span class="nc bnc" id="L66" title="All 4 branches missed.">                if (monsters.size() &lt; MONSTER_NUMBER &amp;&amp; gameStatus) {</span>
<span class="nc" id="L67">                    Creature m = creatureFactory.newMonster(player);</span>
<span class="nc" id="L68">                    m.setStatus(gameStatus);</span>
<span class="nc" id="L69">                    monsters.add(m); // 添加新的怪物</span>
<span class="nc" id="L70">                    exec.execute(m);</span>
                }
<span class="nc" id="L72">            }</span>

        }, 5000, 5000); // 一开始等五秒，之后每五秒检查一次
        // exec.shutdown();

<span class="nc bnc" id="L77" title="All 2 branches missed.">        for (int i = 0; i &lt; FUNGUS_NUMBER; i++) {</span>
<span class="nc" id="L78">            creatureFactory.newFungus();</span>
        }

<span class="nc bnc" id="L81" title="All 2 branches missed.">        for (int i = 0; i &lt; MEDICINE_NUMBER; i++) {</span>
<span class="nc" id="L82">            creatureFactory.newMedicine();</span>
        }

<span class="nc bnc" id="L85" title="All 2 branches missed.">        for (int i = 0; i &lt; AMPLIFIER_NUMBER; i++) {</span>
<span class="nc" id="L86">            creatureFactory.newAmplifier();</span>
        }
<span class="nc" id="L88">    }</span>

    private void createWorld() {
<span class="nc" id="L91">        world = new WorldBuilder(World.WIDTH, World.HEIGHT).makeCaves().build();</span>
<span class="nc" id="L92">    }</span>

    private void displayTiles(AsciiPanel terminal) {
        // Show terrain
<span class="nc bnc" id="L96" title="All 2 branches missed.">        for (int x = 0; x &lt; World.WIDTH; x++) {</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">            for (int y = 0; y &lt; World.HEIGHT; y++) {</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                if (player.canSee(x, y)) {</span>
<span class="nc" id="L99">                    terminal.write(world.glyph(x, y), x, y, world.color(x, y));</span>
                } else {
<span class="nc" id="L101">                    terminal.write(world.glyph(x, y), x, y, Color.DARK_GRAY);</span>
                }
            }
        }
        // Show creatures
<span class="nc bnc" id="L106" title="All 2 branches missed.">        for (Creature creature : world.getCreatures()) {</span>
<span class="nc bnc" id="L107" title="All 4 branches missed.">            if (creature.type() == CreatureType.FUNGUS || creature.type() == CreatureType.MEDICINE ||</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                    creature.type() == CreatureType.AMPLIFIER) {</span>
                // 照亮才能看见
<span class="nc bnc" id="L110" title="All 6 branches missed.">                if (creature.x() &gt;= 0 &amp;&amp; creature.x() &lt; World.WIDTH &amp;&amp; creature.y() &gt;= 0</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">                        &amp;&amp; creature.y() &lt; World.HEIGHT) {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                    if (player.canSee(creature.x(), creature.y())) {</span>
<span class="nc" id="L113">                        terminal.write(creature.glyph(), creature.x(), creature.y(), creature.color());</span>
                    }
                }
            } else {
                // 不用照亮就能看见
<span class="nc bnc" id="L118" title="All 6 branches missed.">                if (creature.x() &gt;= 0 &amp;&amp; creature.x() &lt; World.WIDTH &amp;&amp; creature.y() &gt;= 0</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                        &amp;&amp; creature.y() &lt; World.HEIGHT) {</span>
<span class="nc" id="L120">                    terminal.write(creature.glyph(), creature.x(), creature.y(), creature.color());</span>
                }
            }
<span class="nc" id="L123">        }</span>
        // Creatures can choose their next action now
        // world.update();
<span class="nc" id="L126">    }</span>

    private void displayMessages(AsciiPanel terminal, List&lt;String&gt; messages) {
<span class="nc" id="L129">        int top = World.HEIGHT + 5;</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        for (int i = 0; i &lt; messages.size(); i++) {</span>
<span class="nc" id="L131">            terminal.write(messages.get(i), 1, top + i);</span>
        }
<span class="nc" id="L133">        oldMessages.addAll(messages);</span>
<span class="nc" id="L134">        messages.clear();</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">        if (oldMessages.size() &gt; 0) {</span>
<span class="nc" id="L136">            messages.add(oldMessages.get(oldMessages.size() - 1));</span>
        }
<span class="nc" id="L138">    }</span>

    // setters and getters 序列化输出输入
    private void writeObject(ObjectOutputStream oos) throws IOException {
<span class="nc" id="L142">        oos.defaultWriteObject();</span>
<span class="nc" id="L143">    }</span>

    private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException {
<span class="nc" id="L146">        ois.defaultReadObject();</span>

        // 给大家换上正确的AI
<span class="nc" id="L149">        player = world.playerRemain().get(0);</span>
<span class="nc" id="L150">        new PlayerAI(player, messages);</span>

<span class="nc" id="L152">        List&lt;Creature&gt; monsters = world.monsterRemain();</span>
<span class="nc" id="L153">        List&lt;Creature&gt; fungus = world.fungusRemain();</span>
<span class="nc" id="L154">        List&lt;Creature&gt; medicines = world.medicineRemain();</span>
<span class="nc" id="L155">        List&lt;Creature&gt; amplifiers = world.amplifierRemain();</span>

<span class="nc bnc" id="L157" title="All 2 branches missed.">        for (Creature m : monsters) {</span>
<span class="nc" id="L158">            new MonsterAI(m, this.world, player);</span>
<span class="nc" id="L159">        }</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">        for (Creature f : fungus) {</span>
<span class="nc" id="L161">            new FungusAI(f);</span>
<span class="nc" id="L162">        }</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        for (Creature m : medicines) {</span>
<span class="nc" id="L164">            new MedicineAI(m);</span>
<span class="nc" id="L165">        }</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">        for (Creature a : amplifiers) {</span>
<span class="nc" id="L167">            new AmplifierAI(a);</span>
<span class="nc" id="L168">        }</span>

<span class="nc" id="L170">    }</span>

    // 序列化
    public void serializing() throws IOException, ClassNotFoundException {
<span class="nc" id="L174">        FileOutputStream fileOutputStream = new FileOutputStream(Screen.FileName);</span>
<span class="nc" id="L175">        ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream);</span>
<span class="nc" id="L176">        objectOutputStream.writeObject(this);</span>
<span class="nc" id="L177">        objectOutputStream.flush();</span>
<span class="nc" id="L178">        objectOutputStream.close();</span>
<span class="nc" id="L179">    }</span>

    public void run() {
<span class="nc" id="L182">        gameStatus = false;</span>
        // 跑起来
<span class="nc" id="L184">        ExecutorService exec = Executors.newFixedThreadPool(MONSTER_NUMBER + 1);</span>
<span class="nc" id="L185">        player.setStatus(gameStatus);</span>
<span class="nc" id="L186">        exec.execute(player);</span>

<span class="nc" id="L188">        List&lt;Creature&gt; monsters = world.monsterRemain();</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">        for (Creature m : monsters) { // 添加现有的怪物</span>
<span class="nc" id="L190">            m.setStatus(gameStatus);</span>
<span class="nc" id="L191">            exec.execute(m);</span>
<span class="nc" id="L192">        }</span>
        // 怪物添加
<span class="nc" id="L194">        CreatureFactory creatureFactory = new CreatureFactory(world);</span>
<span class="nc" id="L195">        new Timer().schedule(new TimerTask() {</span>
            @Override
            public void run() {
                // 限制屏幕上剩余怪物数量
<span class="nc" id="L199">                List&lt;Creature&gt; monsters = world.monsterRemain();</span>
<span class="nc bnc" id="L200" title="All 4 branches missed.">                if (monsters.size() &lt; MONSTER_NUMBER &amp;&amp; gameStatus) {</span>
<span class="nc" id="L201">                    Creature m = creatureFactory.newMonster(player);</span>
<span class="nc" id="L202">                    m.setStatus(gameStatus);</span>
<span class="nc" id="L203">                    monsters.add(m); // 添加新的怪物</span>
<span class="nc" id="L204">                    exec.execute(m);</span>
                }
<span class="nc" id="L206">            }</span>

        }, 5000, 5000); // 一开始等五秒，之后每五秒检查一次

<span class="nc" id="L210">    }</span>

    @Override
    public Screen displayOutput(AsciiPanel terminal) {
        // Terrain and creatures
<span class="nc" id="L215">        displayTiles(terminal);</span>
        // Player
<span class="nc" id="L217">        terminal.write(player.glyph(), player.x(), player.y(), player.color());</span>
        // Stats
<span class="nc" id="L219">        String levelstats = String.format(&quot;Level:%3d&quot;, this.level);</span>
<span class="nc" id="L220">        terminal.write(levelstats, 1, World.HEIGHT);</span>

<span class="nc" id="L222">        String hpstats = String.format(&quot;%3d/%3d hp&quot;, player.hp(), player.maxHP());</span>
<span class="nc" id="L223">        terminal.write(hpstats, 1, World.HEIGHT + 2);</span>

<span class="nc" id="L225">        String stats = String.format(&quot;Get%3d/%3d Hearts&quot;, FUNGUS_NUMBER - world.fungusRemain().size(), FUNGUS_NUMBER);</span>
<span class="nc" id="L226">        terminal.write(stats, 1, World.HEIGHT + 3);</span>

        // Messages
<span class="nc" id="L229">        displayMessages(terminal, this.messages);</span>

        // 判断player是不是已经死了
<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (player.hp() &lt;= 0) {</span>
<span class="nc" id="L233">            return new LoseScreen();</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">        } else if (world.fungusRemain().size() == 0) {</span>
            // 是否赢得胜利
<span class="nc" id="L236">            return new WinScreen();</span>
        }
<span class="nc" id="L238">        return this;</span>
    }

    @Override
    public Screen respondToUserInput(KeyEvent key) {
<span class="nc bnc" id="L243" title="All 4 branches missed.">        if (key.isControlDown() &amp;&amp; key.getKeyCode() == KeyEvent.VK_S) {// 同时按下ctrl+S</span>
            // 首先暂停游戏 改变游戏状态
<span class="nc bnc" id="L245" title="All 2 branches missed.">            if (gameStatus) {</span>
<span class="nc" id="L246">                gameStatus = false;</span>
            }
            // 通知怪物
<span class="nc" id="L249">            List&lt;Creature&gt; monsters = world.monsterRemain();</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">            for (Creature m : monsters) {</span>
<span class="nc" id="L251">                m.setStatus(gameStatus);</span>
<span class="nc" id="L252">            }</span>
            // 通知玩家
<span class="nc" id="L254">            player.setStatus(gameStatus);</span>

            // 弹出提示
<span class="nc" id="L257">            int res = JOptionPane.showConfirmDialog(null, &quot;已暂停，是否保存当前游戏进度并退出&quot;, &quot;Option&quot;, JOptionPane.YES_NO_OPTION);</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">            if (res == JOptionPane.YES_OPTION) {</span>
                // 点击“是”后执行这个代码块
                // 保存并退出游戏
                try {
<span class="nc" id="L262">                    serializing();</span>
<span class="nc" id="L263">                } catch (Exception e) {</span>
<span class="nc" id="L264">                    e.printStackTrace();</span>
<span class="nc" id="L265">                    System.out.println(&quot;序列化失败！&quot;);</span>
<span class="nc" id="L266">                }</span>

<span class="nc" id="L268">                JOptionPane.showMessageDialog(null, &quot;保存成功&quot;, &quot;Information&quot;, JOptionPane.INFORMATION_MESSAGE);</span>
<span class="nc" id="L269">                System.exit(0); // 摁退出</span>
            } else {
                // 点击“否”后执行这个代码块
                // 继续游戏
<span class="nc" id="L273">                gameStatus = true;</span>
                // 通知怪物
<span class="nc" id="L275">                monsters = world.monsterRemain();</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">                for (Creature m : monsters) {</span>
<span class="nc" id="L277">                    m.setStatus(gameStatus);</span>
<span class="nc" id="L278">                }</span>
                // 通知玩家
<span class="nc" id="L280">                player.setStatus(gameStatus);</span>
            }

<span class="nc" id="L283">        } else {</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">            switch (key.getKeyCode()) {</span>
                case KeyEvent.VK_SPACE: {
                    // 改变游戏状态
<span class="nc bnc" id="L287" title="All 2 branches missed.">                    if (gameStatus) {</span>
<span class="nc" id="L288">                        gameStatus = false;</span>
                    } else {
<span class="nc" id="L290">                        gameStatus = true;</span>
                    }

                    // 通知怪物
<span class="nc" id="L294">                    List&lt;Creature&gt; monsters = world.monsterRemain();</span>
<span class="nc bnc" id="L295" title="All 2 branches missed.">                    for (Creature m : monsters) {</span>
<span class="nc" id="L296">                        m.setStatus(gameStatus);</span>
<span class="nc" id="L297">                    }</span>

                    // 通知玩家
<span class="nc" id="L300">                    player.setStatus(gameStatus);</span>
                }
<span class="nc" id="L302">                    break;</span>
                default:
<span class="nc" id="L304">                    player.setKeyEvent(key.getKeyCode());</span>
                    break;
            }
        }
<span class="nc" id="L308">        return this;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>